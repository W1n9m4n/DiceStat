<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dice Value Detection</title>
<style>
  body {
    margin: 0; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    font-family: Arial, sans-serif;
  }
  video, canvas {
    border: 1px solid black;
    max-width: 100%;
  }
  #overlay {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }
  #container {
    position: relative;
    display: inline-block;
  }
  #message {
    margin-top: 10px;
    font-weight: bold;
    color: red;
  }
</style>
</head>
<body>

<h1>Dice Value Identification</h1>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
</div>

<div id="message"></div>

<script>
  const API_KEY = "YOUR_API_KEY_HERE";  // <-- Put your actual Roboflow API key here

  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const message = document.getElementById('message');

  let overlayCtx;
  let streamStarted = false;

  // Hidden canvas to capture frames
  const captureCanvas = document.createElement('canvas');
  const captureCtx = captureCanvas.getContext('2d');

  // Start webcam
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
      video.srcObject = stream;
      await video.play();

      // Set capture and overlay canvas size same as video
      captureCanvas.width = video.videoWidth;
      captureCanvas.height = video.videoHeight;

      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
      overlayCtx = overlay.getContext('2d');

      streamStarted = true;

      detectLoop();
    } catch (error) {
      message.textContent = "Error accessing camera: " + error.message;
    }
  }

  // Draw a red square overlay on the full video (you can customize position/size)
  function drawOverlay() {
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
    overlayCtx.strokeStyle = 'red';
    overlayCtx.lineWidth = 4;

    // Example: a centered square covering roughly 50% width and height
    const boxWidth = overlay.width * 0.5;
    const boxHeight = overlay.height * 0.5;
    const boxX = (overlay.width - boxWidth) / 2;
    const boxY = (overlay.height - boxHeight) / 2;

    overlayCtx.strokeRect(boxX, boxY, boxWidth, boxHeight);
  }

  // Detection loop
  async function detectLoop() {
    if (!streamStarted) return;

    try {
      // Capture current video frame to hidden canvas
      captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);

      // Convert canvas to blob (jpeg)
      const blob = await new Promise(resolve => captureCanvas.toBlob(resolve, 'image/jpeg'));

      // Prepare form data with blob and API key
      const formData = new FormData();
      formData.append('file', blob, 'frame.jpg');
      formData.append('api_key', API_KEY);

      // Post to Roboflow detect endpoint (no API key in URL)
      const response = await fetch('https://detect.roboflow.com/dice-value-identification/1', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`API Error: ${response.status} - ${errorText}`);
      }

      const result = await response.json();

      message.textContent = `Detected ${result.predictions.length} objects.`;

      // Clear and redraw overlay
      drawOverlay();

      // Draw bounding boxes on overlay for detected dice values
      result.predictions.forEach(pred => {
        const x = pred.x - pred.width / 2;
        const y = pred.y - pred.height / 2;
        const width = pred.width;
        const height = pred.height;

        overlayCtx.strokeStyle = 'lime';
        overlayCtx.lineWidth = 3;
        overlayCtx.strokeRect(x, y, width, height);

        overlayCtx.fillStyle = 'lime';
        overlayCtx.font = '18px Arial';
        overlayCtx.fillText(pred.class + ' (' + (pred.confidence * 100).toFixed(0) + '%)', x, y > 20 ? y - 5 : y + 20);
      });

    } catch (err) {
      message.textContent = 'API Error: ' + err.message;
      drawOverlay();  // still show the red square even on error
    }

    setTimeout(detectLoop, 2000);  // run detection every 2 seconds
  }

  startCamera();
</script>

</body>
</html>
