<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const key = 'hcMpxDXEVyytWxlYcR00';
  const fileInput   = document.getElementById('fileInput');
  const startCamBtn = document.getElementById('startCamBtn');
  const video       = document.getElementById('video');
  const captureBtn  = document.getElementById('captureBtn');
  const resultsDiv  = document.getElementById('results');
  let stream = null;

  function toJpegDataURI(el) {
    const W = el.videoWidth || el.naturalWidth;
    const H = el.videoHeight || el.naturalHeight;
    const c = document.createElement('canvas');
    c.width = W; c.height = H;
    c.getContext('2d').drawImage(el, 0, 0);
    return c.toDataURL('image/jpeg');
  }
  function strip(dataUri) { return dataUri.split(',')[1]; }

  async function analyze(rawB64) {
    resultsDiv.innerHTML = '<p>Analyzingâ€¦</p>';
    try {
      const payload = {
        api_key: key,
        image: { type: 'base64', value: rawB64 }
      };
      const resp = await axios.post(
        'https://serverless.roboflow.com/dice-9uzag/3',
        payload,
        { headers: { 'Content-Type': 'application/json' } }
      );

      // ensure we have an object
      let data = resp.data;
      if (typeof data === 'string') {
        try { data = JSON.parse(data); }
        catch(_){ /* leave as string */ }
      }

      console.log('Raw API response:', data);

      const preds = Array.isArray(data.predictions) ? data.predictions : [];
      if (preds.length === 0) {
        resultsDiv.innerHTML = `
          <h2>No dice detected</h2>
          <pre style="font-size:0.8em; background:#f4f4f4; padding:0.5em;">${JSON.stringify(data, null,2)}</pre>
        `;
        return;
      }

      const dice  = preds.map(p => Number(p.class));
      const count = dice.length;
      const total = dice.reduce((s,v)=>s+v,0);

      resultsDiv.innerHTML = `
        <h2>Results</h2>
        <ul>
          <li><strong>Dice detected:</strong> ${count}</li>
          <li><strong>Total sum:</strong> ${total}</li>
          <li><strong>Individual rolls:</strong>
            <ul>${dice.map(v=>`<li>${v}</li>`).join('')}</ul>
          </li>
        </ul>
      `;
    } catch (e) {
      console.error('Error calling API:', e);
      const msg = e.response?.data?.message || e.message;
      resultsDiv.innerHTML = `<p style="color:red">Error: ${msg}</p>`;
    }
  }

  // UPLOAD
  fileInput.addEventListener('change', e => {
    stopCam();
    const file = e.target.files[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = () => {
      const img = new Image();
      img.onload = () => analyze(strip(toJpegDataURI(img)));
      img.src = r.result;
    };
    r.readAsDataURL(file);
  });

  // CAMERA
  startCamBtn.addEventListener('click', async () => {
    if (stream) { stopCam(); return; }
    try {
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject = stream; video.hidden = false; captureBtn.hidden = false;
      startCamBtn.textContent = 'Stop Camera';
    } catch (err) { alert('Camera error: '+err.message); }
  });
  captureBtn.addEventListener('click', () => analyze(strip(toJpegDataURI(video))));

  function stopCam(){
    if (stream) stream.getTracks().forEach(t=>t.stop());
    stream=null; video.hidden=true; captureBtn.hidden=true;
    startCamBtn.textContent='Start Camera';
  }
</script>
