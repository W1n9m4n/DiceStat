<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>DiceStat</title>
  <style>
    body { font-family: sans-serif; max-width: 480px; margin: 2em auto; padding: 0 1em; }
    h1 { text-align: center; }
    video, canvas, img { max-width: 100%; border: 1px solid #ccc; margin-top: 0.5em; }
    button, input { font-size: 1em; margin: 0.5em 0; display: block; width: 100%; }
    #results ul { padding-left: 1.2em; }
  </style>
</head>
<body>
  <h1>DiceStat</h1>
  <p>Upload a photo or use your camera to analyze dice rolls.</p>

  <!-- FILE UPLOAD -->
  <label>
    üìÅ Upload image:
    <input type="file" accept="image/*" id="fileInput" />
  </label>

  <hr/>

  <!-- LIVE CAMERA -->
  <button id="startCamBtn">üì∑ Start Camera</button>
  <video id="video" autoplay playsinline hidden></video>
  <button id="captureBtn" hidden>üñºÔ∏è Capture & Analyze</button>

  <div id="results"></div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const fileInput   = document.getElementById('fileInput');
    const startCamBtn = document.getElementById('startCamBtn');
    const video       = document.getElementById('video');
    const captureBtn  = document.getElementById('captureBtn');
    const resultsDiv  = document.getElementById('results');
    let dataUri = '';

    // --- 1) FILE UPLOAD FLOW ---
    fileInput.addEventListener('change', e => {
      stopCamera(); // if camera was running, shut it off
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        dataUri = reader.result;
        analyzeImage(dataUri);
      };
      reader.readAsDataURL(file);
    });

    // --- 2) CAMERA FLOW ---
    let stream = null;
    startCamBtn.addEventListener('click', async () => {
      if (stream) { return stopCamera(); }
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.hidden = false;
        captureBtn.hidden = false;
        startCamBtn.textContent = 'üõë Stop Camera';
      } catch (err) {
        alert('Could not start camera: ' + err.message);
      }
    });

    captureBtn.addEventListener('click', () => {
      // draw current frame to a hidden canvas
      const canvas = document.createElement('canvas');
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      dataUri = canvas.toDataURL('image/jpeg');
      analyzeImage(dataUri);
    });

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.hidden = true;
      captureBtn.hidden = true;
      startCamBtn.textContent = 'üì∑ Start Camera';
    }

    // --- COMMON ANALYSIS FUNCTION ---
    async function analyzeImage(dataUri) {
      resultsDiv.innerHTML = '<p>Analyzing‚Ä¶</p>';
      try {
        const resp = await axios.post(
          'https://serverless.roboflow.com/dice-9uzag/3',
          { image: dataUri },
          {
            params: { api_key: 'hcMpxDXEVyytWxlYcR00' },
            headers: { 'Content-Type': 'application/json' }
          }
        );
        const preds = resp.data.predictions || [];
        const dice = preds.map(p => Number(p.class));
        const count = dice.length;
        const total = dice.reduce((a,b) => a+b, 0);

        resultsDiv.innerHTML = `
          <h2>Results</h2>
          <ul>
            <li><strong>Dice detected:</strong> ${count}</li>
            <li><strong>Total sum:</strong> ${total}</li>
            <li><strong>Individual rolls:</strong>
              <ul>${dice.map(v => `<li>${v}</li>`).join('')}</ul>
            </li>
          </ul>
        `;
      } catch (err) {
        console.error(err);
        const msg = err.response?.data?.message || err.message;
        resultsDiv.innerHTML = `<p style="color:red;">Error: ${msg}</p>`;
      }
    }
  </script>
</body>
</html>
