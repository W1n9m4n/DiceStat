<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DiceStat</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    video, canvas, img { max-width: 100%; }
    #results { margin-top: 1em; }
  </style>
</head>
<body>

  <h1>DiceStat</h1>

  <p>Choose an image or use your webcam to detect dice using Roboflow:</p>
  <input type="file" id="uploadInput" accept="image/*">
  <button id="startCamera">Start Camera</button>
  <button id="capture">Capture</button>
  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" src="" alt="Captured Image" />
  <div id="results"></div>

  <script>
    const API_URL = "https://detect.roboflow.com/dice-9uzag/3";
    const API_KEY = "hcMpxDXEVyytWxlYcR00";

    const uploadInput = document.getElementById("uploadInput");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const preview = document.getElementById("preview");
    const resultsDiv = document.getElementById("results");

    document.getElementById("startCamera").onclick = async () => {
      video.style.display = "block";
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    };

    document.getElementById("capture").onclick = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      const dataUrl = canvas.toDataURL("image/jpeg");
      preview.src = dataUrl;
      sendToRoboflow(dataUrl);
    };

    uploadInput.onchange = () => {
      const file = uploadInput.files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        preview.src = reader.result;
        sendToRoboflow(reader.result);
      };
      reader.readAsDataURL(file);
    };

    function sendToRoboflow(dataUrl) {
      const base64Data = dataUrl.replace(/^data:image\/\w+;base64,/, "");
      fetch(`${API_URL}?api_key=${API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: base64Data
      })
      .then(res => res.json())
      .then(json => {
        console.log(json);
        displayResults(json);
      })
      .catch(err => {
        console.error(err);
        resultsDiv.innerHTML = "Error: " + err.message;
      });
    }

    function displayResults(data) {
      const predictions = data.predictions || [];
      if (!predictions.length) {
        resultsDiv.innerHTML = "<strong>No dice detected.</strong>";
        return;
      }

      let total = 0;
      let rolls = predictions.map(p => {
        const value = parseInt(p.class, 10);
        total += value;
        return value;
      });

      resultsDiv.innerHTML = `
        <strong>Dice detected:</strong> ${rolls.length}<br>
        <strong>Total sum:</strong> ${total}<br>
        <strong>Individual rolls:</strong> ${rolls.join(", ")}
      `;
    }
  </script>
</body>
</html>
