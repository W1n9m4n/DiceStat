<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roboflow Video Inference Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    input, button { font-size: 1rem; padding: 0.5rem; }
    #status { margin-top: 1rem; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Roboflow Video Inference Demo</h1>

  <input type="file" id="videoInput" accept="video/mp4,video/avi,video/mkv,video/webm" />
  <br /><br />
  <button id="startBtn" disabled>Start Video Inference</button>

  <pre id="status"></pre>

  <script>
    const API_KEY = "YOUR_WORKSPACE_API_KEY";  // <<-- PUT YOUR API KEY HERE
    const MODEL_ID = "your_model_id";           // <<-- Your model slug here
    const MODEL_VERSION = "1";                   // <<-- Model version

    const videoInput = document.getElementById("videoInput");
    const startBtn = document.getElementById("startBtn");
    const statusEl = document.getElementById("status");

    let selectedFile;

    videoInput.addEventListener("change", () => {
      if (videoInput.files.length > 0) {
        selectedFile = videoInput.files[0];
        startBtn.disabled = false;
        statusEl.textContent = "";
      } else {
        selectedFile = null;
        startBtn.disabled = true;
      }
    });

    startBtn.addEventListener("click", async () => {
      if (!selectedFile) return alert("Please select a video file.");

      startBtn.disabled = true;
      statusEl.textContent = "Requesting upload signed URL...";

      try {
        // Step 1: Get signed upload URL
        const res1 = await fetch(`https://api.roboflow.com/video_upload_signed_url/?api_key=${API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ file_name: selectedFile.name }),
        });
        const data1 = await res1.json();
        const signedUrl = data1.signed_url;
        if (!signedUrl) throw new Error("Failed to get signed URL");

        statusEl.textContent = "Uploading video to Roboflow...";
        
        // Step 2: Upload video file to signed URL
        await fetch(signedUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/octet-stream" },
          body: selectedFile,
        });
        statusEl.textContent = "Video uploaded successfully.";

        // Extract public video URL (remove query params)
        const publicVideoUrl = signedUrl.split("?")[0];

        statusEl.textContent += "\nScheduling video inference job...";

        // Step 3: Schedule inference job
        const jobBody = {
          input_url: publicVideoUrl,
          infer_fps: 5,
          models: [
            {
              model_id: MODEL_ID,
              model_version: MODEL_VERSION,
              inference_type: "object-detection",
              inference_params: { confidence: 0.4 },
            },
          ],
        };

        const res2 = await fetch(`https://api.roboflow.com/videoinfer/?api_key=${API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(jobBody),
        });

        const data2 = await res2.json();
        if (!data2.job_id) throw new Error("Failed to schedule job");

        statusEl.textContent += `\nJob scheduled. Job ID: ${data2.job_id}`;
        statusEl.textContent += "\nPolling for job completion every 60 seconds...";

        // Step 4: Poll for job status
        await pollJobStatus(data2.job_id);
      } catch (error) {
        statusEl.textContent += `\nError: ${error.message}`;
      }
      startBtn.disabled = false;
    });

    async function pollJobStatus(jobId) {
      let status = 1;
      let retries = 0;
      const maxRetries = 20;

      while (status === 1 && retries < maxRetries) {
        statusEl.textContent += `\nChecking job status... (attempt ${retries + 1})`;
        try {
          const res = await fetch(`https://api.roboflow.com/videoinfer/?api_key=${API_KEY}&job_id=${jobId}`);
          const data = await res.json();
          status = data.status;

          if (status === 0) {
            statusEl.textContent += "\n✅ Job complete!";
            statusEl.textContent += `\nDownload results: ${data.output_signed_url}`;
            // Optionally, you can fetch and parse the JSON here if CORS allows.
            return;
          } else if (status > 1) {
            statusEl.textContent += "\n❌ Job failed.";
            return;
          } else {
            statusEl.textContent += "\n⏳ Still processing...";
          }
        } catch (err) {
          statusEl.textContent += `\nPolling error: ${err.message}`;
        }

        retries++;
        if (status !== 0) {
          await new Promise((r) => setTimeout(r, 60000)); // wait 60 sec before next poll
        }
      }
      if (retries >= maxRetries) {
        statusEl.textContent += "\nPolling timed out.";
      }
    }
  </script>
</body>
</html>
